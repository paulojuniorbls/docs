---
title: 'Webhooks'
description: 'Display inline code and code blocks'
icon: 'code'
---

    Webhooks são um poderoso mecanismo para receber notificações em tempo real sobre eventos importantes. No contexto do **ApiEuAtendo**, o webhook permite que você receba atualizações automáticas diretamente no seu servidor, como o status de mensagens enviadas, recebimento de novas mensagens, entre outros eventos.

    Nesta seção, vamos explicar como os webhooks funcionam e como você pode implementar um servidor usando o framework **Horse** para ouvir os eventos do webhook.

    ## Como Funciona um Webhook?

    Um **webhook** é um "callback" que envia uma solicitação HTTP (geralmente `POST`) a uma URL especificada sempre que ocorre um evento específico. Em vez de você precisar consultar constantemente o sistema para verificar atualizações, o sistema automaticamente envia essas notificações para seu servidor quando certos eventos acontecem.

    ### Exemplo de Eventos Disparados
    - **Recebimento de novas mensagens**: Quando uma nova mensagem é recebida por um cliente.
    - **Status de mensagem**: Quando o status de uma mensagem enviada (como entregue, lido, etc.) é atualizado.
    - **Eventos de conexão e desconexão de instâncias**.

    ## Implementando um Servidor Webhook com Horse

    Vamos implementar um servidor simples usando o framework **Horse** para ouvir as requisições do webhook e processar as notificações recebidas.

    ### Instalação do Horse

    Caso ainda não tenha o Horse instalado no seu projeto, você pode instalá-lo usando o **Boss**, o gerenciador de pacotes para Delphi:

    ```bash
    boss install horse
    ```

    ### Configurando o Servidor Horse

    Aqui está um exemplo de como você pode configurar um servidor simples para escutar as requisições do webhook:

    ```delphi
    program WebhookServer;

    uses
      Horse, // Framework Horse para servidor HTTP
      System.SysUtils, 
      Web.HTTPApp;

    procedure ConfigurarWebhook;
    begin
      // Configurar o endpoint para receber requisições do webhook
      THorse.Post('/webhook', 
        procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
        var
          BodyData: string;
        begin
          // Captura o corpo da requisição (o JSON enviado pelo webhook)
          BodyData := Req.Body;

          // Aqui você pode tratar o JSON e processar as informações
          // Exemplo: tratar status de mensagem
          if BodyData.Contains('message_status') then
          begin
            // Tratar o status da mensagem recebido
            Writeln('Status de mensagem recebido: ', BodyData);
          end;

          // Enviar uma resposta para o serviço que enviou o webhook
          Res.Send('Webhook recebido com sucesso!');
        end);
    end;

    begin
      // Inicia o servidor na porta 9000
      ConfigurarWebhook;
      THorse.Listen(9000);
    end.
    ```

    ### Explicação do Código

    - **THorse.Post('/webhook')**: Cria uma rota para escutar eventos na URL `/webhook`.
    - **Req.Body**: Obtém o corpo da requisição HTTP, que normalmente contém o JSON com os dados do evento disparado.
    - **BodyData.Contains('message_status')**: Exemplo simples de como verificar o tipo de evento recebido. Nesse caso, estamos verificando se o evento contém informações sobre o status de uma mensagem.

    ### Tratamento dos Dados Recebidos

    O JSON enviado pelo webhook pode conter diversas informações, como o status de uma mensagem ou o conteúdo de uma nova mensagem recebida. Você pode usar bibliotecas como **SuperObject** ou **XSuperObject** para processar o JSON e extrair os dados que deseja.

    Exemplo de tratamento de JSON:

    ```delphi
    uses
      XSuperObject;

    procedure TratarWebhook(const BodyData: string);
    var
      Json: ISuperObject;
    begin
      // Carregar o JSON recebido no webhook
      Json := SO(BodyData);

      // Exemplo: acessar o status da mensagem
      if Json.S['event'] = 'message_status' then
      begin
        Writeln('Status: ' + Json.S['status']);
      end;
    end;
    ```

    ## Testando o Webhook

    Para testar o seu webhook, você pode usar ferramentas como **ngrok** para expor o servidor local na internet e verificar se ele está recebendo os eventos corretamente. O **ngrok** cria um túnel seguro para seu servidor local, tornando-o acessível publicamente.

    ### Exemplo de uso do ngrok

    ```bash
    ngrok http 9000
    ```

    Após rodar esse comando, o ngrok fornecerá uma URL pública para seu servidor local que você pode configurar como o endpoint do webhook no sistema.

    ## Conclusão

    Com o webhook configurado, seu sistema será capaz de receber notificações em tempo real sobre eventos importantes. Usando o framework **Horse**, a implementação de um servidor para escutar esses eventos é simples e eficiente, permitindo que você processe as informações de forma ágil e automatizada.
